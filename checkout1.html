<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Yunoxa - Checkout</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Online Shopping in Sri Lanka" name="keywords">
    <meta content="Yunoxa - Best Online Shopping Platform in Sri Lanka" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/checkout.css" rel="stylesheet">
</head>

<body>
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-search nav-icon"></i>
            <span>Search</span>
        </a>
        <a href="index.html" class="nav-item">
            <i class="fas fa-gift nav-icon"></i>
            <span>Deals</span>
        </a>
        <a href="cart.html" class="nav-item">
            <i class="fas fa-shopping-cart nav-icon"></i>
            <span>Cart</span>
        </a>
    </nav>
    <div class="user-info">
        <span id="user-email"></span>
        <button id="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
    
    <!-- Checkout Content -->
    <div class="checkout-container">
        <div class="checkout-header">
            <h1><i class="fas fa-lock"></i> Secure Checkout</h1>
            <div class="checkout-progress">
                <div class="progress-step" id="step-shipping">1. Shipping</div>
                <div class="progress-step" id="step-payment">2. Payment</div>
                <div class="progress-step" id="step-review">3. Review</div>
            </div>
        </div>

        <div class="checkout-body">
            <div class="checkout-main">
                <!-- Shipping Address Section -->
                <section class="checkout-section" id="shipping-section">
                    <h2><i class="fas fa-truck"></i> Shipping Address</h2>
                    <div class="address-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">First Name *</label>
                                <input type="text" id="firstName" placeholder="Enter first name" required>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name *</label>
                                <input type="text" id="lastName" placeholder="Enter last name" required>
                                <div class="error-message"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address">Address *</label>
                            <input type="text" id="address" placeholder="Street address" required>
                            <div class="error-message"></div>
                        </div>
                        <div class="form-group">
                            <label for="address2">Address 2 (Optional)</label>
                            <input type="text" id="address2" placeholder="Apartment, suite, etc.">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City *</label>
                                <input type="text" id="city" placeholder="Enter city" required>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="province">Province *</label>
                                <select id="province" required>
                                    <option value="">Select province</option>
                                    <option value="western">Western Province</option>
                                    <option value="central">Central Province</option>
                                    <option value="southern">Southern Province</option>
                                    <option value="northern">Northern Province</option>
                                    <option value="eastern">Eastern Province</option>
                                    <option value="nw">North Western Province</option>
                                    <option value="nc">North Central Province</option>
                                    <option value="uva">Uva Province</option>
                                    <option value="sabaragamuwa">Sabaragamuwa Province</option>
                                </select>
                                <div class="error-message"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="postalCode">Postal Code *</label>
                                <input type="text" id="postalCode" placeholder="Enter postal code" required>
                                <div class="error-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number *</label>
                                <input type="tel" id="phone" placeholder="Enter phone number" required>
                                <div class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Shipping Method Section -->
                <section class="checkout-section" id="shipping-method-section">
                    <h2><i class="fas fa-shipping-fast"></i> Shipping Method</h2>
                    <div class="shipping-methods">
                        <div class="shipping-method selected">
                            <div class="method-radio">
                                <input type="radio" name="shipping" id="standard" checked>
                                <label for="standard"></label>
                            </div>
                            <div class="method-info">
                                <h3>Standard Shipping</h3>
                                <p>Estimated delivery: Based on delivery partner</p>
                                <p class="shipping-rate">Delivery fee calculated based on quantity</p>
                            </div>
                            <div class="method-price" id="delivery-price">Calculating...</div>
                        </div>
                    </div>
                </section>

                <!-- Payment Section (initially hidden) -->
                <section class="checkout-section" id="payment-section" style="display: none;">
                    <h2><i class="fas fa-credit-card"></i> Payment Method</h2>
                    <div class="payment-methods">
                        <div class="payment-method selected">
                            <div class="method-radio">
                                <input type="radio" name="payment" id="whatsapp" checked disabled>
                                <label for="whatsapp"></label>
                            </div>
                            <div class="method-info">
                                <h3>Order via WhatsApp</h3>
                                <p>Complete your order by contacting us on WhatsApp</p>
                                <div class="whatsapp-icon">
                                    <i class="fab fa-whatsapp"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="checkout-actions">
                        <button class="btn-back" id="back-to-shipping"><i class="fas fa-arrow-left"></i> Back to Shipping</button>
                        <button class="btn-continue" id="continue-to-review">Continue to Review</button>
                    </div>
                </section>

                <!-- Review Section (initially hidden) -->
                <section class="checkout-section" id="review-section" style="display: none;">
                    <h2><i class="fas fa-check-circle"></i> Review Your Order</h2>
                    
                    <div class="review-section">
                        <h3><i class="fas fa-truck"></i> Shipping Information</h3>
                        <div class="review-info" id="review-shipping">
                            <!-- Dynamically filled with shipping info -->
                        </div>
                    </div>
                    
                    <div class="review-section">
                        <h3><i class="fas fa-credit-card"></i> Payment Method</h3>
                        <div class="review-info" id="review-payment">
                            <!-- Dynamically filled with payment info -->
                        </div>
                    </div>
                    
                    <div class="checkout-actions">
                        <button class="btn-back" id="back-to-payment"><i class="fas fa-arrow-left"></i> Back to Payment</button>
                        <button class="btn-confirm" id="confirm-order">Confirm & Send WhatsApp Message</button>
                    </div>
                </section>

                <div class="checkout-actions" id="initial-actions">
                    <a href="open.html?id=${new URLSearchParams(window.location.search).get('id')}" class="back-to-cart"><i class="fas fa-arrow-left"></i> Back to Product</a>
                    <button class="btn-continue" id="continue-to-payment">Continue to Payment</button>
                </div>
            </div>

            <div class="checkout-sidebar">
                <div class="order-summary">
                    <h2><i class="fas fa-shopping-bag"></i> Order Summary</h2>
                    <div class="order-items" id="order-items-container">
                        <!-- Single product will be shown here -->
                    </div>
                    <div class="order-totals">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span id="subtotal-price">LKR 0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Shipping</span>
                            <span id="shipping-price">Calculating...</span>
                        </div>
                        <div class="total-row discount">
                            <span>Discount</span>
                            <span id="discount-price">LKR 0.00</span>
                        </div>
                        <div class="total-row grand-total">
                            <span>Total</span>
                            <span id="total-price">LKR 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="quantity-selector">
                    <label for="quantity">Quantity:</label>
                    <div class="quantity-controls">
                        <button class="quantity-btn minus"><i class="fas fa-minus"></i></button>
                        <input type="number" id="quantity" min="1" value="1">
                        <button class="quantity-btn plus"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div class="secure-checkout">
                    <p><i class="fas fa-lock"></i> Secure checkout</p>
                    <p><i class="fas fa-shield-alt"></i> Buyer protection</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

    <!-- Checkout Script -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        
        // Initialize Supabase
        const supabase = createClient(
            'https://qopdjgfciakmvhlriixt.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcGRqZ2ZjaWFrbXZobHJpaXh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk0NDA2NDAsImV4cCI6MjA1NTAxNjY0MH0.5UAelwww7WpDUExqhc5dH2JhUWlGNgUNjh8fzxPNZvs'
        )
        
        // Track verification state
        let verificationInProgress = false
        let verificationInterval
        let currentUser = null;
        let productData = null;
        let deliveryPrice = 0;
        let whatsappNumber = '767087651'; // Default number
        
        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        
        // Enhanced verification with ban detection
        async function verifySession() {
            if (verificationInProgress) return false;
            
            verificationInProgress = true;
            console.log('Starting session verification...');
        
            try {
                // 1. Check current session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError || !session) {
                    throw new Error('No active session');
                }
        
                // 2. Verify user status - THIS DETECTS BANS
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError) {
                    // Specific check for banned users
                    if (userError.message.includes('disabled') || userError.message.includes('banned')) {
                        console.warn('User account is banned/disabled');
                        await handleBan();
                        return false;
                    }
                    throw userError;
                }
                
                if (!user) {
                    throw new Error('User verification failed');
                }
        
                // 3. Update local storage
                localStorage.setItem('supabase_session', JSON.stringify({
                    user: user,
                    session: session
                }));
                
                // Update current user
                currentUser = user;
                
                // Update UI
                updateUserUI(user);
                
                console.log('Session verified successfully');
                return true;
        
            } catch (error) {
                console.warn('Session verification failed:', error.message);
                await handleLogout();
                return false;
            } finally {
                verificationInProgress = false;
            }
        }
        
        // Special handling for banned users
        async function handleBan() {
            console.log('Processing ban...');
            try {
                // 1. Force logout from Supabase
                const { error } = await supabase.auth.signOut();
                if (error) console.error('Ban logout error:', error);
                
                // 2. Clear local data
                localStorage.removeItem('supabase_session');
                
                // 3. Show ban message
                alert('Your account has been restricted. Please contact support.');
                
                // 4. Redirect to login
                window.location.href = 'login.html';
            } catch (e) {
                console.error('Ban handling failed:', e);
                window.location.href = 'login.html';
            }
        }
        
        // Normal logout handler
        async function handleLogout() {
            try {
                await supabase.auth.signOut();
            } catch (e) {
                console.error('Logout error:', e);
            } finally {
                localStorage.removeItem('supabase_session');
                window.location.href = 'login.html';
            }
        }
        
        // Update UI elements
        function updateUserUI(user) {
            const emailElement = document.getElementById('user-email');
            if (emailElement) {
                emailElement.textContent = user.email || "User";
            }
        }
        
        // Load product details
        async function loadProductDetails() {
            // Early check for user session
            if (!currentUser) {
                console.warn('Attempted to load product without user session');
                return;
            }
        
            if (!productId) {
                alert('No product selected');
                window.location.href = 'index.html';
                return;
            }
        
            try {
                // Fetch product details
                const { data: product, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', productId)
                    .single();
        
                if (error) throw error;
                if (!product) {
                    alert('Product not found');
                    window.location.href = 'index.html';
                    return;
                }
        
                // Store product data
                productData = product;
                
                // Set WhatsApp number if available
                if (product.whatsapp_no) {
                    whatsappNumber = product.whatsapp_no;
                }
        
                // Set delivery price
                deliveryPrice = product.delivery || 350; // Default to 350 if not set
        
                // Update product display
                updateProductDisplay();
                updateOrderSummary();
        
            } catch (error) {
                console.error("Error loading product:", error);
                alert('Error loading product details');
                window.location.href = 'index.html';
            }
        }
        
        // Update product display in order summary
        function updateProductDisplay() {
            if (!productData) return;
        
            const container = document.getElementById('order-items-container');
            const currentPrice = productData.discount > 0 
                ? (productData.price * (1 - productData.discount/100)).toFixed(2)
                : productData.price.toFixed(2);
            
            container.innerHTML = `
                <div class="order-item">
                    <div class="item-image">
                        <img src="${productData.image}" alt="">
                    </div>
                    <div class="item-details">
                        <h3>${productData.name}</h3>
                        ${productData.discount > 0 ? `<p>Discount: ${productData.discount}%</p>` : ''}
                        <div class="item-price">LKR ${currentPrice}</div>
                        <div class="item-quantity">Qty: <span id="display-quantity">1</span></div>
                    </div>
                </div>
            `;
        }
        
        // Calculate shipping cost based on quantity
        function calculateShippingCost(quantity) {
            if (quantity === 1) return deliveryPrice;
            return deliveryPrice + ((quantity - 1) * (deliveryPrice / 2));
        }
        
        // Update order summary with current values
        function updateOrderSummary() {
            if (!productData) return;
        
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const shippingCost = calculateShippingCost(quantity);
            const subtotal = (productData.price * (1 - (productData.discount || 0)/100)) * quantity;
            const discountAmount = (productData.price * (productData.discount || 0)/100) * quantity;
            const total = subtotal + shippingCost;
        
            // Update displayed quantities
            document.getElementById('display-quantity').textContent = quantity;
            document.getElementById('subtotal-price').textContent = `LKR ${subtotal.toFixed(2)}`;
            document.getElementById('shipping-price').textContent = `LKR ${shippingCost.toFixed(2)}`;
            document.getElementById('delivery-price').textContent = `LKR ${shippingCost.toFixed(2)}`;
            
            if (discountAmount > 0) {
                document.getElementById('discount-price').textContent = `-LKR ${discountAmount.toFixed(2)}`;
                document.querySelector('.total-row.discount').style.display = 'flex';
            } else {
                document.querySelector('.total-row.discount').style.display = 'none';
            }
            
            document.getElementById('total-price').textContent = `LKR ${total.toFixed(2)}`;
        }
        
        // Form validation function
        function validateShippingForm() {
            let isValid = true;
            const requiredFields = [
                'firstName', 'lastName', 'address', 
                'city', 'province', 'postalCode', 'phone'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorMsg = field.parentElement.querySelector('.error-message');
                
                if (!field.value.trim()) {
                    errorMsg.textContent = 'This field is required';
                    isValid = false;
                } else {
                    errorMsg.textContent = '';
                }
            });
            
            return isValid;
        }
        
        // Function to update review sections with entered information
        function updateReviewSections() {
            // Shipping info
            const shippingInfo = `
                <p>${document.getElementById('firstName').value} ${document.getElementById('lastName').value}</p>
                <p>${document.getElementById('address').value}</p>
                ${document.getElementById('address2').value ? `<p>${document.getElementById('address2').value}</p>` : ''}
                <p>${document.getElementById('city').value}, ${document.getElementById('province').value}</p>
                <p>${document.getElementById('postalCode').value}</p>
                <p>Phone: ${document.getElementById('phone').value}</p>
                <p>Shipping Method: Standard Shipping</p>
            `;
            document.getElementById('review-shipping').innerHTML = shippingInfo;
            
            // Payment info
            document.getElementById('review-payment').innerHTML = `
                <p>Order via WhatsApp</p>
                <p>You will be redirected to WhatsApp to complete your order</p>
            `;
        }
        
        // Generate WhatsApp message
        function generateWhatsAppMessage() {
            try {
                if (!currentUser) {
                    throw new Error("User not logged in");
                }
        
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const shippingCost = calculateShippingCost(quantity);
                const subtotal = (productData.price * (1 - (productData.discount || 0)/100)) * quantity;
                const total = subtotal + shippingCost;
                
                const productLink = `${window.location.origin}/open.html?id=${productId}`;
                
                let message = `Hello Seller!%0A%0A` +
                       `I would like to order:%0A%0A` +
                       `*Product:* ${productData.name}%0A` +
                       `*Quantity:* ${quantity}%0A` +
                       `*Price:* LKR ${(productData.price * (1 - (productData.discount || 0)/100)).toFixed(2)} each%0A` +
                       `*Subtotal:* LKR ${subtotal.toFixed(2)}%0A` +
                       `*Delivery:* LKR ${shippingCost.toFixed(2)}%0A` +
                       `*Total:* LKR ${total.toFixed(2)}%0A%0A` +
                       `*Shipping Details:*%0A` +
                       `Name: ${document.getElementById('firstName').value} ${document.getElementById('lastName').value}%0A` +
                       `Address: ${document.getElementById('address').value}%0A` +
                       `${document.getElementById('address2').value ? `Address 2: ${document.getElementById('address2').value}%0A` : ''}` +
                       `City: ${document.getElementById('city').value}%0A` +
                       `Province: ${document.getElementById('province').value}%0A` +
                       `Postal Code: ${document.getElementById('postalCode').value}%0A` +
                       `Phone: ${document.getElementById('phone').value}%0A%0A` +
                       `*Product Link:* ${productLink}%0A%0A`;
                
                // Safely add user info if available
                if (currentUser.email) {
                    message += `*Customer Email:* ${currentUser.email}%0A`;
                }
                if (currentUser.id) {
                    message += `*User UUID:* ${currentUser.id}`;
                }
                
                return message;
                
            } catch (error) {
                console.error("Error generating WhatsApp message:", error);
                // Return a basic message without user info if there's an error
                return `Hello Seller!%0A%0AI would like to place an order. Please contact me.`;
            }
        }
        
        // Setup quantity controls
        function setupQuantityControls() {
            document.querySelector('.quantity-btn.minus').addEventListener('click', function() {
                const input = document.getElementById('quantity');
                if (parseInt(input.value) > 1) {
                    input.value = parseInt(input.value) - 1;
                    updateOrderSummary();
                }
            });
        
            document.querySelector('.quantity-btn.plus').addEventListener('click', function() {
                const input = document.getElementById('quantity');
                input.value = parseInt(input.value) + 1;
                updateOrderSummary();
            });
        
            document.getElementById('quantity').addEventListener('change', function() {
                if (this.value < 1) this.value = 1;
                updateOrderSummary();
            });
        }
        
        // Initial verification on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // First verify session
                const isVerified = await verifySession();
                if (!isVerified) {
                    // If not verified, verifySession will handle the redirect
                    return;
                }
                
                // Only load product details if verified
                await loadProductDetails();
                setupQuantityControls();
                
                // Setup periodic verification
                setTimeout(async () => {
                    await verifySession();
                    verificationInterval = setInterval(verifySession, 15 * 1000);
                }, 10 * 1000);
        
                // Cleanup interval when page unloads
                window.addEventListener('beforeunload', () => {
                    if (verificationInterval) {
                        clearInterval(verificationInterval);
                    }
                });
        
                // Manual logout handler
                document.getElementById('logout-btn')?.addEventListener('click', async () => {
                    if (verificationInterval) {
                        clearInterval(verificationInterval);
                    }
                    await handleLogout();
                });
        
                // Continue to Payment Button
                document.getElementById('continue-to-payment').addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (validateShippingForm()) {
                        // Hide shipping sections
                        document.getElementById('shipping-section').style.display = 'none';
                        document.getElementById('shipping-method-section').style.display = 'none';
                        document.getElementById('initial-actions').style.display = 'none';
                        
                        // Show payment section
                        document.getElementById('payment-section').style.display = 'block';
                        
                        // Update progress steps
                        document.getElementById('step-shipping').classList.remove('active');
                        document.getElementById('step-payment').classList.add('active');
                        
                        // Scroll to top
                        window.scrollTo(0, 0);
                    }
                });
                
                // Back to Shipping Button
                document.getElementById('back-to-shipping').addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Show shipping sections
                    document.getElementById('shipping-section').style.display = 'block';
                    document.getElementById('shipping-method-section').style.display = 'block';
                    document.getElementById('initial-actions').style.display = 'flex';
                    
                    // Hide payment section
                    document.getElementById('payment-section').style.display = 'none';
                    
                    // Update progress steps
                    document.getElementById('step-payment').classList.remove('active');
                    document.getElementById('step-shipping').classList.add('active');
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                });
                
                // Continue to Review Button
                document.getElementById('continue-to-review').addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update review sections with entered information
                    updateReviewSections();
                    
                    // Hide payment section
                    document.getElementById('payment-section').style.display = 'none';
                    
                    // Show review section
                    document.getElementById('review-section').style.display = 'block';
                    
                    // Update progress steps
                    document.getElementById('step-payment').classList.remove('active');
                    document.getElementById('step-review').classList.add('active');
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                });
                
                // Back to Payment Button
                document.getElementById('back-to-payment').addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Show payment section
                    document.getElementById('payment-section').style.display = 'block';
                    
                    // Hide review section
                    document.getElementById('review-section').style.display = 'none';
                    
                    // Update progress steps
                    document.getElementById('step-review').classList.remove('active');
                    document.getElementById('step-payment').classList.add('active');
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                });
                
                // Confirm Order Button
                document.getElementById('confirm-order').addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Show loading state
                    const btn = document.getElementById('confirm-order');
                    btn.disabled = true;
                    btn.innerHTML = 'Preparing... <i class="fas fa-spinner fa-spin"></i>';
                    
                    // Generate WhatsApp message
                    const message = generateWhatsAppMessage();
                    
                    // Open WhatsApp after short delay
                    setTimeout(() => {
                        window.open(`https://api.whatsapp.com/send/?phone=${whatsappNumber}&text=${message}`, '_blank');
                        btn.innerHTML = 'WhatsApp Opened!';
                    }, 1000);
                });
            } catch (error) {
                console.error("Initialization error:", error);
                // Fallback redirect if something goes wrong
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
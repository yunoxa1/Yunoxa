<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Product Details | Yunoxa</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="description" content="Amazing deals on quality products - Tomorrow’s vibes, today">

    <!-- Favicon -->
<link rel="icon" href="img/Favicon.svg" type="image/svg+xml">
<link rel="icon" href="img/Favicon.png" type="image/png">
<link rel="shortcut icon" href="img/Favicon.ico" type="image/x-icon">


    <!-- Open Graph Meta Tags (Dynamic for Social Sharing) -->
    <meta property="og:title" id="og-title" content="Yunoxa - Amazing Deals">
    <meta property="og:description" id="og-description" content="Check out this product on Yunoxa!">
    <meta property="og:image" id="og-image" content="https://yunoxa.com/img/default-product-image.jpg">
    <meta property="og:url" id="og-url" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Yunoxa">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitter-title" content="Yunoxa - Amazing Deals">
    <meta name="twitter:description" id="twitter-description" content="Check out this product on Yunoxa!">
    <meta name="twitter:image" id="twitter-image" content="https://yunoxa.com/img/default-product-image.jpg">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link href="css/open.css" rel="stylesheet">

    <!-- Preload OG Tags (Fallback for WhatsApp) -->
    <script>
        // Set default OG tags (fallback if JS fails)
        document.getElementById('og-url').content = window.location.href;
    </script>
</head>

<body>
    <!-- Header -->
    <header class="yunoxa-header">
        <div class="header-top">
            <div class="logo">Yunoxa<span>!</span></div>
            <div class="header-icons">
                
                <a href="favorites.html">
                    <i class="fas fa-heart"></i>
                    <span class="favorites-count">0</span>
                </a>
            </div>
        </div>
        
        <nav class="category-nav">

        </nav>
    </header>

    <!-- Product Detail Container -->
    <div class="product-detail-container">
        <!-- Product Image Section -->
        <div class="y-product-image-container">
            <img id="main-product-image" src="img/loadi.gif" alt="Product Image">
            <div class="image-gallery">
                <img class="thumbnail active" src="img/loadi.gif" alt="Thumbnail 1">
                <img class="thumbnail" src="img/loadi.gif" alt="Thumbnail 2">
                <img class="thumbnail" src="img/loadi.gif" alt="Thumbnail 3">
                <img class="thumbnail" src="img/loadi.gif" alt="Thumbnail 4">
            </div>
        </div>
        

        <!-- Product Info Section -->
        <div class="product-info">
            <h1 class="product-title">Loading...</h1>
            
            <div class="price-container">
                <span class="current-price">LKR 0.00</span>
                <span class="original-price">LKR 0.00</span>
                <span class="discount-badge">0% OFF</span>
            </div>
            
            <div class="rating-section">
                <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                    <i class="far fa-star"></i>
                </div>
                <span class="rating-count">4.2</span>
                <span class="sold-count">Random Reviews</span>
            </div>
            
            <div class="badge-container">
                <span class="badge"><i class="fas fa-bolt"></i> Flash Deal</span>
                <span class="badge"><i class="fas fa-truck"></i> Island Wide Delivery</span>
            </div>
            
            <div class="delivery-info">
                <p><i class="fas fa-truck"></i> Free delivery for Some products</p>
                <p><i class="fas fa-star"></i> Tomorrow’s vibes, today</p>
                <p><i class="fas fa-shield-alt"></i> Safest Store</p>
            </div>
            
            <div class="quantity-selector">
                <button class="quantity-btn minus"><i class="fas fa-minus"></i></button>
                <input type="text" class="quantity-input" value="1">
                <button class="quantity-btn plus"><i class="fas fa-plus"></i></button>
            </div>
            
            <div class="button-group">
                <button class="add-to-favorites-btn">
                    <i class="fas fa-favorites-plus"></i> Add to favorites
                </button>
                <a href="#" class="buy-now-btn" onclick="buyNow()">Buy Now</a>
            </div>
            
            <div class="share-buttons">
                <a href="#" class="share-btn" onclick="shareOnWhatsApp()"><i class="fab fa-whatsapp"></i></a>
                <a href="#" class="share-btn" onclick="shareOnFacebook()"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="share-btn" onclick="shareOnTwitter()"><i class="fab fa-twitter"></i></a>
                <a href="#" class="share-btn" onclick="shareOnPinterest()"><i class="fab fa-pinterest-p"></i></a>
            </div>
        </div>
    </div>

    <!-- Product Description -->
    <div class="product-detail-container">
        <div class="product-info">
            <div class="product-description">
                <h3>Product Description</h3>
                <p id="product-description-text">Loading product details...</p>
            </div>
        </div>
    </div>
    <div class="product-info-container">
        <div class="product-info">
            <div class="product-description">
                <h3>Product details</h3>
                <p id="product-details-text">Loading product details...</p>
            </div>
        </div>
    </div>

    <!-- Recommended Products -->
    <div class="product-detail-container">
        <div class="product-info">
            <h3 style="margin-bottom: 15px;">Recommended For You</h3>
            <div class="products-grid" id="recommended-products">
                <!-- Recommended products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-search nav-icon"></i>
            <span>Search</span>
        </a>
        
        <a href="favorites.html" class="nav-item">
            <i class="fas fa-heart nav-icon"></i>
            <span>favorites</span>
        </a>

        <a href="myprofile.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>Account</span>
        </a>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span>Item added to favorites!</span>
    </div>
<script src="js/cookie.js"></script>
    <!-- JavaScript -->
    <script type="module">
        // Cloudflare Worker Proxy URL
        const PROXY_API_URL = 'https://api-proxy.yunoxa1.workers.dev';
        
        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
    
        // Initialize favorites count
        updatefavoritesCount();
    
        // Helper function to fetch data through proxy
        async function fetchFromProxy(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
            };
            
            try {
                const response = await fetch(`${PROXY_API_URL}${endpoint}`, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error fetching from proxy:', error);
                throw error;
            }
        }
    
        async function loadProductDetails() {
            if (!productId) {
                document.body.innerHTML = '<div class="error">Product not found</div>';
                return;
            }
    
            try {
                // Fetch product data through proxy
                const product = await fetchFromProxy(`/rest/v1/products?id=eq.${productId}&verification=eq.1&select=*`);
                
                if (!product || product.length === 0) {
                    document.body.innerHTML = '<div class="error">Product not found</div>';
                    return;
                }
    
                const productData = product[0];
    
                // Update product details in UI
                document.querySelector('.product-title').textContent = productData.name;
                
                // Calculate and display price
                const currentPrice = productData.discount > 0 
                    ? (productData.price * (1 - productData.discount/100)).toFixed(2)
                    : productData.price.toFixed(2);
                
                const priceContainer = document.querySelector('.price-container');
                priceContainer.innerHTML = `
                    <span class="current-price">LKR ${currentPrice}</span>
                    ${productData.discount > 0 ? `
                        <span class="original-price">LKR ${productData.price.toFixed(2)}</span>
                        <span class="discount-badge">${productData.discount}% OFF</span>
                    ` : ''}
                `;
    
                // Update product description
                document.getElementById('product-description-text').textContent = 
                    productData.description || 'No description available';
                document.getElementById('product-details-text').textContent = 
                    productData.details || 'No details available';
    
                // Update product images
                const images = [
                    productData.image,
                    productData.image1,
                    productData.image2,
                    productData.image3,
                    productData.image4
                ].filter(img => img);
    
                if (images.length > 0) {
                    const mainImg = document.getElementById('main-product-image');
                    mainImg.src = images[0];
                    mainImg.onload = () => mainImg.classList.remove('loading-shimmer');
                    
                    const gallery = document.querySelector('.image-gallery');
                    gallery.innerHTML = images.map((img, index) => `
                        <img class="thumbnail ${index === 0 ? 'active' : ''}" 
                             src="${img}" 
                             alt="Product thumbnail ${index + 1}"
                             onclick="changeMainImage('${img}', this)">
                    `).join('');
                }
    
                // Update Open Graph meta tags for social sharing
                updateOpenGraphTags(productData);
    
                // Load recommended products
                loadRecommendedProducts(productData.categorize);
    
            } catch (error) {
                console.error("Error loading product:", error);
                document.querySelector('.product-title').textContent = "Error loading product";
            }
        }
    
        function updateOpenGraphTags(product) {
            // Ensure product.image is an absolute URL
            const absoluteImageUrl = product.image.startsWith('http') 
                ? product.image 
                : `https://yunoxa.com/${product.image.replace(/^\//, '')}`;
    
            // Update OG tags dynamically
            document.querySelector('meta[property="og:title"]').content = product.name;
            document.querySelector('meta[property="og:description"]').content = 
                product.description || "Amazing product on Yunoxa";
            document.querySelector('meta[property="og:image"]').content = absoluteImageUrl;
            document.querySelector('meta[property="og:url"]').content = window.location.href;
            
            // Update Twitter card tags
            document.querySelector('meta[name="twitter:title"]').content = product.name;
            document.querySelector('meta[name="twitter:description"]').content = 
                product.description || "Amazing product on Yunoxa";
            document.querySelector('meta[name="twitter:image"]').content = absoluteImageUrl;
        }
    
         window.buyNow = async function() {
        const quantity = parseInt(document.querySelector('.quantity-input').value);
        
        try {
            // First fetch the product through proxy
            const product = await fetchFromProxy(`/rest/v1/products?id=eq.${productId}&verification=eq.1&select=*`);
            
            if (!product || product.length === 0) {
                console.error("Product not found");
                return;
            }

            const productData = product[0];
            const discountedPrice = productData.discount > 0 
                ? productData.price * (1 - productData.discount/100)
                : productData.price;
            
            // Use product's whatsapp_no or fallback to default
            const whatsappNumber = productData.whatsapp_no || '94767087651';
            const deliveryCharge = productData.delivery || 350;
            
            // Generate WhatsApp message
            const productLink = window.location.href;
            const totalPrice = (discountedPrice * quantity) + deliveryCharge;
            
            const message = `Hello Seller! I Found This Product on Yunoxa%0A%0A` +
                   `*Product:* ${productData.name}%0A` +
                   `*Price:* LKR ${discountedPrice.toFixed(2)}%0A` +
                   `*Quantity:* ${quantity}%0A` +
                   `*Delivery:* LKR ${deliveryCharge.toFixed(2)}%0A` +
                   `*Total:* LKR ${totalPrice.toFixed(2)}%0A%0A` +
                   `*Product Link:* ${productLink}%0A%0A` +
                   `I'm interested in buying this item. Please provide more details.`;
            
            // Open WhatsApp with the message
            window.open(`https://api.whatsapp.com/send/?phone=${whatsappNumber}&text=${message}`, '_blank');
            
        } catch (error) {
            console.error("Error in buyNow:", error);
            showToast("Error processing your order");
        }
    }
    
        document.querySelector('.buy-now-btn').addEventListener('click', function(e) {
            e.preventDefault();
            buyNow();
        });
    
        async function loadRecommendedProducts(categorize) {
            try {
                const products = await fetchFromProxy(`/rest/v1/products?categorize=eq.${encodeURIComponent(categorize)}&verification=eq.1&limit=8`);
    
                const container = document.getElementById('recommended-products');
                if (products && products.length > 0) {
                    container.innerHTML = products.map(product => `
                        <div class="product-card">
                            <a href="open.html?id=${product.id}">
                                <div class="image-container">
                                    <img src="${product.image || 'https://via.placeholder.com/250'}" 
                                         alt="" 
                                         class="product-image">
                                </div>
                                <div class="product-info">
                                    <div class="product-price">
                                        LKR ${product.discount > 0 
                                            ? (product.price * (1 - product.discount/100)).toFixed(2) 
                                            : product.price.toFixed(2)}
                                        ${product.discount > 0 ? 
                                            `<span class="product-original-price">LKR ${product.price.toFixed(2)}</span>` : ''}
                                    </div>
                                    
                                    <a href="open.html?id=${product.id}" class="product-title">${product.name}</a>
                                </div>
                            </a>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No recommended products found</p>';
                }
            } catch (error) {
                console.error("Error loading recommended products:", error);
            }
        }
    
        // Change main image when thumbnail is clicked
        window.changeMainImage = function(src, element) {
            document.getElementById('main-product-image').src = src;
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            element.classList.add('active');
        }
    
        // Quantity selector functionality
        document.querySelector('.quantity-btn.minus').addEventListener('click', function() {
            const input = document.querySelector('.quantity-input');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        });
    
        document.querySelector('.quantity-btn.plus').addEventListener('click', function() {
            const input = document.querySelector('.quantity-input');
            input.value = parseInt(input.value) + 1;
        });
    
        // Add to favorites functionality
        document.querySelector('.add-to-favorites-btn').addEventListener('click', addTofavorites);
    
        async function addTofavorites() {
            const quantity = parseInt(document.querySelector('.quantity-input').value);
    
            try {
                const product = await fetchFromProxy(`/rest/v1/products?id=eq.${productId}&verification=eq.1&select=*`);
                
                if (!product || product.length === 0) {
                    console.error("Product not found");
                    return;
                }
    
                const productData = product[0];
                const discountedPrice = productData.discount > 0 
                    ? productData.price * (1 - productData.discount/100)
                    : productData.price;
    
                let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
                const existingItem = favorites.find(item => item.id === productData.id);
    
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    favorites.push({
                        id: productData.id,
                        name: productData.name,
                        price: discountedPrice,
                        originalPrice: productData.price,
                        quantity: quantity,
                        image: productData.image,
                        discount: productData.discount || 0
                    });
                }
    
                localStorage.setItem('favorites', JSON.stringify(favorites));
                showToast();
                updatefavoritesCount();
            } catch (error) {
                console.error("Error adding to favorites:", error);
            }
        }
    
        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    
        function updatefavoritesCount() {
            const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            const totalItems = favorites.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector('.favorites-count').textContent = totalItems;
        }
    
        // Social sharing functions (unchanged)
        window.shareOnWhatsApp = function() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://api.whatsapp.com/send?text=Check out this product: ${url}`, '_blank');
        }
    
        window.shareOnFacebook = function() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }
    
        window.shareOnTwitter = function() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?url=${url}`, '_blank');
        }
    
        window.shareOnPinterest = function() {
            const url = encodeURIComponent(window.location.href);
            const media = encodeURIComponent(document.getElementById('main-product-image').src);
            window.open(`https://pinterest.com/pin/create/button/?url=${url}&media=${media}`, '_blank');
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            // Mark all elements as loading
            const selectors = [
                '.y-product-image-container',
                '.product-title',
                '.price-container',
                '.product-description',
                '.delivery-info',
                '.product-image-container'
            ];
            
            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.classList.add('loading-shimmer');
                });
            });
    
            // Generic load handler
            const handleLoad = (element) => {
                element.classList.add('loaded');
                let parent = element.parentElement;
                while (parent) {
                    if (parent.classList.contains('loading-shimmer')) {
                        parent.classList.add('loaded');
                    }
                    parent = parent.parentElement;
                }
            };
    
            // Process images
            document.querySelectorAll('img').forEach(img => {
                if (img.complete) handleLoad(img);
                img.onload = () => handleLoad(img);
                img.onerror = () => handleLoad(img);
            });
    
            // Optional: Watch for dynamic content
            new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && node.matches(selectors.join(','))) {
                            node.classList.add('loading-shimmer');
                        }
                    });
                });
            }).observe(document.body, { childList: true, subtree: true });
    
            // Load product details
            loadProductDetails();
            updatefavoritesCount();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Product Details | Yunoxa</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="description" content="Amazing deals on quality products - Shop like yunoxa">

    <!-- Favicon -->
    <link rel="icon" href="https://img.kwcdn.com/product/open/2023-09-19/1695100220116-7e3a8b7a3a1e4b1d8f8f5a0a5d1a9a7a-goods.jpeg?imageView2/2/w/800/q/70/format/webp" type="image/jpeg">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link href="css/open.css" rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <header class="yunoxa-header">
        <div class="header-top">
            <div class="logo">Yunoxa<span>!</span></div>
            <div class="header-icons">
                <a href="#"><i class="far fa-bell"></i></a>
                <a href="cart.html">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
            </div>
        </div>
        
        <nav class="category-nav">

        </nav>
    </header>

    <!-- Product Detail Container -->
    <div class="product-detail-container">
        <!-- Product Image Section -->
        <div class="y-product-image-container">
            <img id="main-product-image" src="img/loadi.gif" alt="Product Image">
            <div class="image-gallery">
                <img class="thumbnail active" src="img/loadi.gif" alt="Thumbnail 1">
                <img class="thumbnail" src="img/loadi.gif" alt="Thumbnail 2">
                <img class="thumbnail" src="img/loadi.gif" alt="Thumbnail 3">
                <img class="thumbnail" src="img/loadi.gif" alt="Thumbnail 4">
            </div>
        </div>
        

        <!-- Product Info Section -->
        <div class="product-info">
            <h1 class="product-title">Loading...</h1>
            
            <div class="price-container">
                <span class="current-price">LKR 0.00</span>
                <span class="original-price">LKR 0.00</span>
                <span class="discount-badge">0% OFF</span>
            </div>
            
            <div class="rating-section">
                <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                    <i class="far fa-star"></i>
                </div>
                <span class="rating-count">4.2</span>
                <span class="sold-count">Random Reviews</span>
            </div>
            
            <div class="badge-container">
                <span class="badge"><i class="fas fa-check"></i> Free Returns</span>
                <span class="badge"><i class="fas fa-bolt"></i> Flash Deal</span>
                <span class="badge"><i class="fas fa-truck"></i> Island Wide Delivery</span>
            </div>
            
            <div class="delivery-info">
                <p><i class="fas fa-truck"></i> Free delivery for orders over LKR 20000</p>
                <p><i class="fas fa-star"></i> Tomorrowâ€™s vibes, today</p>
                <p><i class="fas fa-shield-alt"></i> 100% Authentic Products</p>
            </div>
            
            <div class="quantity-selector">
                <button class="quantity-btn minus"><i class="fas fa-minus"></i></button>
                <input type="text" class="quantity-input" value="1">
                <button class="quantity-btn plus"><i class="fas fa-plus"></i></button>
            </div>
            
            <div class="button-group">
                <button class="add-to-cart-btn">
                    <i class="fas fa-cart-plus"></i> Add to Cart
                </button>
                <a href="#" class="buy-now-btn" onclick="buyNow()">Buy Now</a>
            </div>
            
            <div class="share-buttons">
                <a href="#" class="share-btn" onclick="shareOnWhatsApp()"><i class="fab fa-whatsapp"></i></a>
                <a href="#" class="share-btn" onclick="shareOnFacebook()"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="share-btn" onclick="shareOnTwitter()"><i class="fab fa-twitter"></i></a>
                <a href="#" class="share-btn" onclick="shareOnPinterest()"><i class="fab fa-pinterest-p"></i></a>
            </div>
        </div>
    </div>

    <!-- Product Description -->
    <div class="product-detail-container">
        <div class="product-info">
            <div class="product-description">
                <h3>Product Description</h3>
                <p id="product-description-text">Loading product details...</p>
            </div>
        </div>
    </div>
    <div class="product-info-container">
        <div class="product-info">
            <div class="product-description">
                <h3>Product details</h3>
                <p id="product-details-text">Loading product details...</p>
            </div>
        </div>
    </div>

    <!-- Recommended Products -->
    <div class="product-detail-container">
        <div class="product-info">
            <h3 style="margin-bottom: 15px;">Recommended For You</h3>
            <div class="products-grid" id="recommended-products">
                <!-- Recommended products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-search nav-icon"></i>
            <span>Search</span>
        </a>
        <a href="#" class="nav-item">
            <i class="fas fa-gift nav-icon"></i>
            <span>Deals</span>
        </a>
        <a href="cart.html" class="nav-item">
            <i class="fas fa-shopping-cart nav-icon"></i>
            <span>Cart</span>
        </a>
        
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span>Item added to cart!</span>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
        const supabaseUrl = 'https://qopdjgfciakmvhlriixt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcGRqZ2ZjaWFrbXZobHJpaXh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk0NDA2NDAsImV4cCI6MjA1NTAxNjY0MH0.5UAelwww7WpDUExqhc5dH2JhUWlGNgUNjh8fzxPNZvs';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // Initialize cart count
        updateCartCount();

        async function loadProductDetails() {
    if (!productId) {
        document.body.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div></div>';
        return;
    }

    try {
        // Fetch product details
        const { data: product, error } = await supabase
            .from('products')
            .select('*')
            .eq('id', productId)
            .single();

        if (error) throw error;
        if (!product) {
            document.body.innerHTML = '<h1>Product not found</h1>';
            return;
        }

        // Update product details
        document.querySelector('.product-title').textContent = product.name;
        
        // Handle price display based on discount status
        const currentPrice = product.discount > 0 
            ? (product.price * (1 - product.discount/100)).toFixed(2)
            : product.price.toFixed(2);
        
        document.querySelector('.current-price').textContent = `LKR ${currentPrice}`;
        
        const priceContainer = document.querySelector('.price-container');
        priceContainer.innerHTML = `
            <span class="current-price">LKR ${currentPrice}</span>
            ${product.discount !== null && product.discount > 0 ? `
                <span class="original-price">LKR ${product.price.toFixed(2)}</span>
                <span class="discount-badge">${product.discount}% OFF</span>
            ` : `
                ${product.discount === null ? `
                    <span class="discount-badge offer-ended">Offer Ended</span>
                ` : ''}
            `}
        `;

        // Update product description
        document.getElementById('product-description-text').textContent = product.description || 'No description available';
        document.getElementById('product-details-text').textContent = product.details || 'No details available';

        // Update product images
        const images = [
            product.image,
            product.image1,
            product.image2,
            product.image3,
            product.image4
        ].filter(img => img);

        if (images.length > 0) {
            document.getElementById('main-product-image').src = images[0];
            const gallery = document.querySelector('.image-gallery');
            gallery.innerHTML = images.map((img, index) => `
                <img class="thumbnail ${index === 0 ? 'active' : ''}" 
                     src="${img}" 
                     alt="Product thumbnail ${index + 1}"
                     onclick="changeMainImage('${img}', this)">
            `).join('');
        }

        // Load recommended products
        loadRecommendedProducts(product.categorize);

    } catch (error) {
        console.error("Error loading product:", error);
        document.querySelector('.product-title').textContent = "Error loading product";
    }
}

// Add this function to your script
window.buyNow = async function() {
    const productId = urlParams.get('id');
    const quantity = parseInt(document.querySelector('.quantity-input').value);

    // First add the item to cart
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const { data: product, error } = await supabase
        .from('products')
        .select('*')
        .eq('id', productId)
        .single();

    if (error) {
        console.error("Error fetching product:", error);
        return;
    }

    const discountedPrice = product.discount > 0 
        ? product.price * (1 - product.discount/100)
        : product.price;

    // Clear the cart first for "Buy Now" functionality
    cart = [{
        id: product.id,
        name: product.name,
        price: discountedPrice,
        originalPrice: product.price,
        quantity: quantity,
        image: product.image,
        discount: product.discount || 0
    }];

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    
    // Then redirect to checkout page with the product ID
    window.location.href = `checkout1.html?id=${productId}`;
}

// Update the existing event listener to use this function
document.querySelector('.buy-now-btn').addEventListener('click', function(e) {
    e.preventDefault();
    buyNow();
});


        async function loadRecommendedProducts(categorize) {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('categorize', categorize)
                    .limit(8);

                if (error) throw error;

                const container = document.getElementById('recommended-products');
                if (products && products.length > 0) {
                    container.innerHTML = products.map(product => `
                        <div class="product-card">
                            <a href="open.html?id=${product.id}">
                                <div class="image-container">
                                    <img src="${product.image || 'https://via.placeholder.com/250'}" 
                                         alt="${product.name}" 
                                         class="product-image">
                                </div>
                                <div class="product-info">
                                    <div class="product-price">
                                        LKR ${product.discount > 0 
                                            ? (product.price * (1 - product.discount/100)).toFixed(2) 
                                            : product.price.toFixed(2)}
                                        ${product.discount > 0 ? 
                                            `<span class="product-original-price">LKR ${product.price.toFixed(2)}</span>` : ''}
                                    </div>
                                    
                                    <a href="open.html?id=${product.id}" class="product-title">${product.name}</a>
                                </div>
                            </a>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No recommended products found</p>';
                }
            } catch (error) {
                console.error("Error loading recommended products:", error);
            }
        }

        // Change main image when thumbnail is clicked
        window.changeMainImage = function(src, element) {
            document.getElementById('main-product-image').src = src;
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Quantity selector functionality
        document.querySelector('.quantity-btn.minus').addEventListener('click', function() {
            const input = document.querySelector('.quantity-input');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        });

        document.querySelector('.quantity-btn.plus').addEventListener('click', function() {
            const input = document.querySelector('.quantity-input');
            input.value = parseInt(input.value) + 1;
        });

        // Add to cart functionality
        document.querySelector('.add-to-cart-btn').addEventListener('click', addToCart);

        async function addToCart() {
            const productId = urlParams.get('id');
            const quantity = parseInt(document.querySelector('.quantity-input').value);

            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const { data: product, error } = await supabase
                .from('products')
                .select('*')
                .eq('id', productId)
                .single();

            if (error) {
                console.error("Error fetching product:", error);
                return;
            }

            const discountedPrice = product.discount > 0 
        ? product.price * (1 - product.discount/100)
        : product.price;
    
    const existingItem = cart.find(item => item.id === product.id);

    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: discountedPrice, // Store the discounted price
            originalPrice: product.price, // Store original for reference
            quantity: 1,
            image: product.image,
            discount: product.discount || 0
        });
    }

            localStorage.setItem('cart', JSON.stringify(cart));
            showToast();
            updateCartCount();
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector('.cart-count').textContent = totalItems;
        }

        // Social sharing functions
        window.shareOnWhatsApp = function() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://api.whatsapp.com/send?text=Check out this product: ${url}`, '_blank');
        }

        window.shareOnFacebook = function() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }

        window.shareOnTwitter = function() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?url=${url}`, '_blank');
        }

        window.shareOnPinterest = function() {
            const url = encodeURIComponent(window.location.href);
            const media = encodeURIComponent(document.getElementById('main-product-image').src);
            window.open(`https://pinterest.com/pin/create/button/?url=${url}&media=${media}`, '_blank');
        }
document.addEventListener('DOMContentLoaded', function() {
    // Mark all elements as loading
    const selectors = [
        '.y-product-image-container',
        '.product-title',
        '.price-container',
        '.product-description',
        '.delivery-info',
        '.product-image-container'
    ];
    
    selectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            el.classList.add('loading-shimmer');
        });
    });

    // Generic load handler
    const handleLoad = (element) => {
        element.classList.add('loaded');
        let parent = element.parentElement;
        while (parent) {
            if (parent.classList.contains('loading-shimmer')) {
                parent.classList.add('loaded');
            }
            parent = parent.parentElement;
        }
    };

    // Process images
    document.querySelectorAll('img').forEach(img => {
        if (img.complete) handleLoad(img);
        img.onload = () => handleLoad(img);
        img.onerror = () => handleLoad(img);
    });

    // Optional: Watch for dynamic content
    new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1 && node.matches(selectors.join(','))) {
                    node.classList.add('loading-shimmer');
                }
            });
        });
    }).observe(document.body, { childList: true, subtree: true });
});
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProductDetails();
            updateCartCount();
        });
    </script>
</body>
</html>